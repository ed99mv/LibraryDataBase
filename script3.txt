-- database: c:\Library_DataBase\LibraryDataBase\library_DB.sqlite3

-- Use the ▷ button in the top right corner to run the entire file.

-- CREACION DE TABLA BOOKS
CREATE TABLE Books (
    Book_ID INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
    Name VARCHAR(30) NOT NULL,
    Author_ID,
    Description VARCHAR(100) NOT NULL,
    ISBN VARCHAR(100) NOT NULL,
    Publication_date DATE NOT NULL,
    Rental_Amount INTEGER NOT NULL,
    Number_Copies INTEGER NOT NULL,
    State VARCHAR(10),
    FOREIGN KEY (Author_ID) REFERENCES Author (Author_ID)
);
INSERT INTO Books(Name, Author_ID, Description, ISBN,
 Publication_date, Rental_Amount, Number_Copies, State)
VALUES ("EL cuervo", 1,
 "El poema El cuevo parte de un tópico literario común: la muerte de la mujer amada. Con este tópico como referencia, la cuestión fundamental parece girar en torno a la muerte como destino inexorable, a su aceptación.",
 "ISBN 978-84-218-6669-6", "1845-01-21", 30000.00, 58, "Disponible"
),
("El Corazón Delator", 1,
 "La historia presenta a un narrador anónimo obsesionado con el ojo enfermo -que llama ojo de buitre- de un anciano con el cual convive. Finalmente decide asesinarlo. El crimen es planeado cuidadosamente y, tras ser perpetrado, el cadáver es despedazado y escondido bajo las tablas del suelo de la casa.",
 "ISBN 978-9963-51-685-8", "1843-01-12", 28000.00, 30, "Disponible"
),
("Orgullo y Prejuicio", 2,
 "En esta daptación de la célebre novela de Jane Austen, la joven Lizzie conoce al apuesto y elegante señor Darcy, pero, a primera vista, le parece demasiado orgulloso y arrogante.",
 "ISBN 978-9963-51-686-5", "1813-01-28", 31000.00, 58, "Disponible"
),
("Emma", 2,
"Conocemos la vida de la joven Emma Woodhouse, que vive en la Inglaterra georgiana. Emma se ocupa de emparejar, unas veces más acertadamente que otras, a sus amigos y familiares.",
 "ISBN 978-84-218-6671-9", "1815-12-23", 27000.00, 25, "Disponible"
),
("Don Quijote de la Mancha", 3, 
 "El libro relata las aventuras y desventuras de un hidalgo de 50 años llamado Alonso Quijano, quien decide ser un caballero andante como aquellos que aparecen en sus libros de caballerías favoritos. Las hazañas de don Quijote están contenidas en dos tomos que narran tres salidas.",
 "ISBN 978-84-486-0902-3", "1605-01-16", 25000.00, 20, "Disponible"
),
(" La Gitanilla", 3,
 "La gitanilla es la primera novela ejemplar de Miguel de Cervantes. Esta historia cuenta la vida y las andanzas de una bella gitana de la que se enamora un joven noble. Cuando este le declara su amor, ella le impone dos condiciones: esperar dos años para casarse y llevar mientras tanto una vida de gitano.",
 "ISBN 978-01-905-0341-3", "1613-01-21", 30000.00, 23, "Disponible"
),
("Muerte en el Nilo", 4,
 "Unas apacibles vacaciones en Egipto de una pareja de recién casados se truncan con un asesinato. La joven Linnet aparece muerta durante el crucero por el Nilo. Tiene un disparo en la cabeza. El detective Hércules Poirot será el encargado de tratar de resolver el misterio.",
 "ISBN 978-9963-48-975-6", "1937-11-01", 22000.00, 16, "Disponible"
),
("Las Manzanas", 4,
 "Durante los preparativos de una fiesta de Halloween, Joyce Reynolds —una adolescente conocida por su fecunda imaginación y por las mentiras que cuenta habitualmente— explica a todo el mundo que en una ocasión presenció un asesinato. Nadie cree lo que oye y ella se marcha enfurecida.",
 "ISBN 978-84-218-6669-6", "1969-11-01", 21000.00, 20, "Disponible"
),
("Once Minutos", 5,
 "Maria es de un pueblo situado al norte de Brasil. Todavía adolescente, viaja a Río de Janeiro, donde conoce a un empresario que le ofrece un buen trabajo en Ginebra. Allí, Maria sueña con encontrar fama y fortuna, pero acabará ejerciendo la prostitución.",
 "ISBN 978-01-905-0328-4", "2003-01-12", 15000.00, 18, "Disponible"
),
("Adulterio", 5,
 "Linda está casada con un hombre rico, tienen dos hijos y la familia vive en una hermosa casa en Ginebra, Suiza. Trabaja en el periódico más importante del país, es guapa, viste bien y tiene todo lo que se pueda desear. A ojos de todos, su vida es perfecta. Sin embargo, no es feliz; una gran insatisfacción la corroe y se siente culpable por no ser capaz de disfrutar de lo que tiene. Por eso no habla con nadie de lo que sucede. Ama a su marido pero la relación con él se ha vuelto rutinaria, apática.",
 "ISBN 978-84-218-6674-0", "2014-04-10", 20000.00, 20, "Disponible"
),
("Tiempos Dificiles", 6,
 "En Coketown, trasunto de cualquier ciudad industrial de la Inglaterra victoriana, el rígido y práctico director de escuela Thomas Gradgrind y su socio, el presuntuoso y mezquino empresario Josiah Bounderby, imponen su ley y su estrecha y árida visión de la vida a alumnos y obreros, cada uno en su ámbito.",
 "ISBN 978-9963-51-703-9", "1854-08-12", 30000.00, 10, "Disponible"
),
("Calle Sin Salida", 6,
 "En el Londres de mediados del siglo XIX, la vida cotidiana de un joven hombre de negocios se complica de forma repentina. Una difícil promesa hecha a un amigo, la traición de alguien en quien confía y el deseo de ser digno de su amada van a dar un giro a su existencia.",
 "ISBN 978-84-675-8702-9", "1867-08-12", 22000.00, 14, "Disponible"
),
(" Los Pilares De la Tierra", 7,
 "Los pilares de la Tierra es una novela histórica del autor británico Ken Follett, ambientada en Inglaterra en la Edad Media, en concreto en el siglo XII, durante un periodo de guerra civil conocido como la anarquía inglesa, entre el hundimiento del White Ship y el asesinato del arzobispo Thomas Becket.",
 "ISBN    978-84-486-0876-7", "1989-01-21", 21000.00, 24, "Disponible"
),
("Un Mundo Sin Fin", 7,
 "Los pilares de la Tierra narra los acontecimientos de la ciudad inglesa de Kingsbridge entre 1135 y 1174. Con Un mundo sin fin regresamos a Kingsbridge, pero 153 años después.",
 "ISBN 978-84-218-6669-6", "2007-01-21", 20000.00, 58, "Disponible"
),
("Romance Gitano", 8,
 "Cuenta la historia de un joven gitano que es asesinado por sus propios primos en un acto de venganza. El poema denuncia la violencia y la crueldad inherentes a la sociedad andaluza de la época y, al mismo tiempo, rinde homenaje al coraje y la dignidad de los gitanos.",
 "ISBN 978-84-682-0121-4", "1928-01-21", 22000.00, 10, "Disponible"
),
("Poeta En New York", 8,
 "Poeta en Nueva York fue para Lorca un grito de horror, de denuncia contra la injusticia y la discriminación, contra la deshumanización de la sociedad moderna y la alienación del ser humano, al tiempo que reclamaba una nueva dimensión humana donde predominase la libertad y la justicia, el amor y la belleza.",
 "ISBN 978-84-218-4957-6", "1940-03-12", 18000.00, 12, "Disponible"
),
("Cien Años De Soledad", 9,
 "En Cien Años de Soledad, el autor narra en 20 capítulos la historia de la familia Buendía a lo largo de siete generaciones en el pueblo ficticio de Macondo -comenzando por el patriarca José Arcadio Buendía y su prima y esposa Úrsula Iguarán-, amalgamando fantasía y realidad.",
 "ISBN 978-9963-51-085-6", "1967-05-01", 19000.00, 25, "Disponible"
),
("Todos Los Cuentos", 9,
 "Este volumen excepcional reúne por primera vez todos los cuentos del Premio Nobel de Literatura Gabriel García Márquez.",
 "ISBN 978-9963-51-086-3", "1975-05-22", 17000.00, 20, "Disponible"
),
("El viejo Y El Mar", 10,
 "Con un lenguaje de gran fuerza y sencillez,El viejo y el mar narra la historia de un viejo pescador cubano a quien la suerte parece haber abandonado, y del desafío mayor al que se enfrenta: la batalla despiadada y sin tregua con un pez gigantesco en las aguas del golfo.",
 "ISBN 978-84-682-2948-5", "1952-02-02", 20000.00, 58, "Disponible"
),
("Fiesta", 10,
 "Esta hermosa y punzante historia narra la excursión a Pamplona de un grupo de americanos e ingleses exiliados en París en los años veinte, donde se reencuentran la seductora Brett Ashley y el desventurado Jake Barnes, que durante la Primera Guerra Mundial vivieron un amor genuino e irrealizable.",
 "ISBN 978-84-481-9154-2", "1926-10-22", 20000.00, 58, "Disponible"
);
select * from Books;














-----------------------------------------
--CREACION DE TABLA SHOPPING_CART
CREATE TABLE Shopping_Cart(
    Shopping_Cart_ID INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
    User_ID INTEGER NOT NULL,
    Book_ID INTEGER NOT NULL,
    Rental_Time_ID INTEGER NOT NULL,
    Payment_Amount DECIMAL NOT NULL,
    Loan_Date DATETIME DEFAULT CURRENT_TIMESTAMP,
    Return_Date DATETIME NOT NULL,
    Late_Amount DECIMAL NOT NULL,
    Transaction_Numer INTEGER NOT NULL,
    State VARCHAR(15),
    FOREIGN KEY (Book_ID) REFERENCES Books (Book_ID),
    FOREIGN KEY (User_ID) REFERENCES Users (User_ID),
    FOREIGN KEY (Rental_Time_ID) REFERENCES Rental_Time (Rental_Time_ID)
);
INSERT INTO Shopping_Cart(
User_ID,
Book_ID,
Rental_Time_ID,
Payment_Amount,
Return_Date,
Late_Amount,
Transaction_Numer,
State)
VALUES(4, 1, 1, 20000, DATE('NOW', '+7 day'), 0.15,"abc23323","Disponible");

select * from Shopping_Cart;

--CREACIÓN DE TRIGGER PARA ACTUALIZAR INVENTARIO CADA VEZ QUE SE RENTE UN LIBRO
CREATE TRIGGER update_inventory
AFTER INSERT
ON Shopping_Cart
FOR EACH ROW
BEGIN
    UPDATE Inventory
    SET Quantity_avaible = 
        CASE WHEN (SELECT Quantity_avaible FROM Inventory WHERE Book_ID = NEW.Book_ID) > 0
                 THEN Quantity_avaible - 1
                 ELSE Quantity_avaible
        END,
        Already_rentad = 
        CASE WHEN (SELECT Quantity_avaible FROM Inventory WHERE Book_ID = NEW.Book_ID) > 0
                 THEN Already_rentad + 1
                 ELSE Already_rentad
        END
    WHERE Book_ID = NEW.Book_ID;
END;
------------------------------------------------------------
SELECT Quantity_avaible FROM Inventory WHERE Book_ID = 2;
DROP TRIGGER update_inventory;
DROP TRIGGER update_inventory;
DROP TABLE Shopping_Cart;
UPDATE Inventory set Quantity_avaible = 0 
where Inventory_ID = 1;













------------------------------------------
--CREACIÓN DE TABLA GenreBook
CREATE TABLE GenreBook(
    GenreBook_ID INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
    Book_ID,
    Genre_ID,
    FOREIGN KEY (Book_ID) REFERENCES Books (Book_ID),
    FOREIGN KEY (Genre_ID) REFERENCES Genre (Genre_ID)
);
INSERT INTO GenreBook(Book_ID, Genre_ID)
VALUES(1, 14),
    (2, 1), 
    (2, 2 ), 
    (3, 3),
    (3, 4),
    (4, 5),
    (4, 7),
    (5, 3),
    (5, 6),
    (6, 7),
    (7, 8),
    (7, 3),
    (7, 9),
    (8, 8),
    (8, 9),
    (9, 3),
    (9, 7),
    (10, 7),
    (11, 3),
    (11, 7),
    (12, 11),
    (13, 12),
    (13, 3),
    (13, 13),
    (14, 13),
    (15, 14),
    (16, 14),
    (17, 15),
    (17, 16),
    (18, 15),
    (19, 17),
    (19, 18),
    (20, 12),
    (20, 19);



DROP TABLE Inventory;











-------------------------------------------
--CREACIÓN DE TABLA Genre
CREATE TABLE Genre(
    Genre_ID INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
    Description VARCHAR(100) NOT NULL
);

INSERT INTO Genre(Description)
VALUES ("Terror"),
    ("Ficción Gótica"),
    ("Novela"),
    ("Romance"),
    ("Comedia"),
    ("Parodiama"),
    ("Ficción"),
    ("Misterio"),
    ("Ficcion Criminal"),
    ("Novela"),
    ("Cine Negro"),
    ("Novela Histórica"),
    ("Ficción Histórica"),
    ("Poesía"),
    ("Realismo Mágico"),
    ("Alta fantasía"),
    ("Alegoría"),
    ("Historia de mar"),
    ("Novela en clave"),
    ("Narrativo"),
    ("Lírico"),
    ("Dramático"),
    ("Ditáctico");















--------------------------------------------
--CREACIÓN DE TABLA Inventory
CREATE TABLE Inventory(
    Inventory_ID INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
    Book_ID INTEGER NOT NULL,
    Quantity_avaible INTEGER NOT NULL,
    Already_rentad INTEGER NOT NULL,
    FOREIGN KEY (Book_ID) REFERENCES Books (Book_ID)
);
INSERT INTO Inventory(Book_ID, Quantity_avaible, Already_rentad)
VALUES (1, 58, 0),
    (2, 30, 0),
    (3, 58, 0),
    (4, 20, 0),
    (5, 25, 0),
    (6, 20, 0),
    (7, 23, 0),
    (8, 16, 0),
    (9, 20, 0),
    (10, 18, 0),
    (11, 10, 0),
    (12, 14, 0),
    (13, 24, 0),
    (14, 58, 0), 
    (15, 10, 0),
    (16, 12, 0),
    (17, 25, 0),
    (18, 20, 0),
    (19, 58, 0),
    (20, 58, 0);